{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "networkRange": {
            "type": "string",
            "metadata": {
                "description": "This defines address space of network"
            
            },

            "defaultValue": "10.10.0.0/16"

        },
        "subnetRange": {
            "type": "array",
            "metadata": {
                "description": "This defines address space of subnets"
            },
            "defaultValue": ["10.10.0.0/24","10.10.1.0/24","10.10.2.0/24"]
        }, 

        "subnetNames": {
            "type": "array",
            "metadata": {
                "description": "This is subnet names"
            },

            "defaultValue": ["web","app","db"]
        },

        "appnsginfo": {
            "type": "object",
            "metadata": {
                "description": "This is appnsg security rules"
            },

            "defaultValue": {
                "name": "appnsg",

                "securityRules": [
                {
                    "name": "openhttps",
                    "access": "Allow",
                    "description": "Open https port",
                    "destinationAddressPrefix": "*",
                    "destinationPortRange": "443",
                    "direction": "Inbound",
                    "priority": "300",
                    "protocol": "Tcp",
                    "sourceAddressPrefix": "*",
                    "sourcePortRange": "*"   
                },

                 {
                    "name": "openssh",
                    "access": "Allow",
                    "description": "Open ssh port",
                    "destinationAddressPrefix": "*",
                    "destinationPortRange": "22",
                    "direction": "Inbound",
                    "priority": "310",
                    "protocol": "Tcp",
                    "sourceAddressPrefix": "*",
                    "sourcePortRange": "*"
                }

                ]
            
            }
        }
    },

    "resources": [
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2023-04-01",
            "name": "ntier",
            "location": "[resourceGroup().location]",
            "tags": {
                "env": "dev"
            },
            "properties": {
                "addressSpace": {
                    "addressPrefixes": ["[parameters('networkRange')]"]
                }
                
            }

        },

       {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2022-09-01",
            "name": "[format('ntier/{0}',parameters('subnetNames')[copyIndex()])]",
            "properties": {
                "addressPrefix": "[parameters('subnetRange')[copyIndex()]]"
            }, 
            
            "dependsOn": ["[resourceId('Microsoft.Network/virtualNetworks', 'ntier')]"],

            "copy": {
                "name": "subnetCopy",
                "count": "[length(parameters('subnetRange'))]",
                "mode": "Serial"
            }

        },
        {
          "type": "Microsoft.Network/networkSecurityGroups",
          "apiVersion": "2023-04-01",
          "name": "webnsg",
          "location":"[resourceGroup().location]",
          "properties": {
            "securityRules": [
                {
                    "name": "AllowHttps",
                    "properties": {
                        "access": "Allow",
                        "description": "Open https port",
                        "destinationAddressPrefix": "*",
                        "destinationPortRange": "443",
                        "direction": "Inbound",
                        "priority": "300",
                        "protocol": "Tcp",
                        "sourceAddressPrefix": "*",
                        "sourcePortRange": "*"



                    }
                },

                 {
                    "name": "Allowssh",
                    "properties": {
                        "access": "Allow",
                        "description": "Open ssh port",
                        "destinationAddressPrefix": "*",
                        "destinationPortRange": "22",
                        "direction": "Inbound",
                        "priority": "310",
                        "protocol": "Tcp",
                        "sourceAddressPrefix": "*",
                        "sourcePortRange": "*"



                    }
                },

                 {
                    "name": "AllowHttp",
                    "properties": {
                        "access": "Allow",
                        "description": "Open http port",
                        "destinationAddressPrefix": "*",
                        "destinationPortRange": "80",
                        "direction": "Inbound",
                        "priority": "320",
                        "protocol": "Tcp",
                        "sourceAddressPrefix": "*",
                        "sourcePortRange": "*"



                    }
                 }
            ]
          }
            
        },
        
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2023-04-01",
            "name": "appnsg",
            "location": "[resourceGroup().location]",
            "properties": {}
        },

        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules", 
            "apiVersion": "2023-04-01",
            "name": "[format('{0}/{1}',parameters('appnsginfo').name,parameters('appnsginfo').securityRules[copyIndex()].name)]",
             "properties": {
                 "access": "[parameters('appnsginfo').securityRules[copyIndex()].access]",
                 "description": "[parameters('appnsginfo').securityRules[copyIndex()].description]",
                 "destinationAddressPrefix": "[parameters('appnsginfo').securityRules[copyIndex()].destinationAddressPrefix]",
                 "destinationPortRange": "[parameters('appnsginfo').securityRules[copyIndex()].destinationPortRange]",
                 "direction": "[parameters('appnsginfo').securityRules[copyIndex()].direction]",
                 "priority": "[parameters('appnsginfo').securityRules[copyIndex()].priority]",
                 "protocol": "[parameters('appnsginfo').securityRules[copyIndex()].protocol]",
                 "sourceAddressPrefix": "[parameters('appnsginfo').securityRules[copyIndex()].sourceAddressPrefix]",
                 "sourcePortRange": "[parameters('appnsginfo').securityRules[copyIndex()].sourcePortRange]"
                 },

         "copy": {
         "name": "appnsginfocopy",
         "count": "[length(parameters('appnsginfo').securityRules)]",
         "mode": "Serial"
         },        

           "dependsOn": ["[resourceId('Microsoft.Network/networkSecurityGroups', 'appnsg')]"]    
        }
        
        
     
    ]

}


