{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "networkRange": {
            "type": "string",
            "metadata": {
                "description": "This defines address space of network"
            
            },

            "defaultValue": "10.10.0.0/16"

        },
        "subnetRange": {
            "type": "array",
            "metadata": {
                "description": "This defines address space of subnets"
            },
            "defaultValue": ["10.10.0.0/24","10.10.1.0/24","10.10.2.0/24"]
        }, 

        "subnetNames": {
            "type": "array",
            "metadata": {
                "description": "This is subnet names"
            },

            "defaultValue": ["web","app","db"]
        }
    },

    "resources": [
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2023-04-01",
            "name": "ntier",
            "location": "[resourceGroup().location]",
            "tags": {
                "env": "dev"
            },
            "properties": {
                "addressSpace": {
                    "addressPrefixes": ["[parameters('networkRange')]"]
                }
                
            }

        },

       {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2022-09-01",
            "name": "[format('ntier/{0}',parameters('subnetNames')[copyIndex()])]",
            "properties": {
                "addressPrefix": "[parameters('subnetRange')[copyIndex()]]"
            }, 
            
            "dependsOn": ["[resourceId('Microsoft.Network/virtualNetworks', 'ntier')]"],

            "copy": {
                "name": "subnetCopy",
                "count": "[length(parameters('subnetRange'))]",
                "mode": "Serial"
            }

        },
        {
          "type": "Microsoft.Network/networkSecurityGroups",
          "apiVersion": "2023-04-01",
          "name": "webnsg",
          "location":"[resourceGroup().location]",
          "properties": {
            "securityRules": [
                {
                    "name": "AllowHttps",
                    "properties": {
                        "access": "Allow",
                        "description": "Open https port",
                        "destinationAddressPrefix": "*",
                        "destinationPortRange": "443",
                        "direction": "Inbound",
                        "priority": "300",
                        "protocol": "Tcp",
                        "sourceAddressPrefix": "*",
                        "sourcePortRange": "*"



                    }
                },

                 {
                    "name": "Allowssh",
                    "properties": {
                        "access": "Allow",
                        "description": "Open ssh port",
                        "destinationAddressPrefix": "*",
                        "destinationPortRange": "22",
                        "direction": "Inbound",
                        "priority": "310",
                        "protocol": "Tcp",
                        "sourceAddressPrefix": "*",
                        "sourcePortRange": "*"



                    }
                },

                 {
                    "name": "AllowHttp",
                    "properties": {
                        "access": "Allow",
                        "description": "Open http port",
                        "destinationAddressPrefix": "*",
                        "destinationPortRange": "80",
                        "direction": "Inbound",
                        "priority": "320",
                        "protocol": "Tcp",
                        "sourceAddressPrefix": "*",
                        "sourcePortRange": "*"



                    }
                }
            ]
          }
            
        }
     
    ]

}